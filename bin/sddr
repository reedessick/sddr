#!/usr/bin/env python

__usage__ = "sddr [--options] samples.hdf5 [samples.hdf5 samples.hdf5 ...]"
__doc__ = ""
__author__ = "reed.essick@ligo.org"

#-------------------------------------------------

from sddr import utils
import numpy as np

from optparse import OptionParser

#-------------------------------------------------

parser = OptionParser(usage=__usage__, description=__doc__)

parser.add_option('-v', '--verbose', default=False, action='store_true')
parser.add_option('-V', '--Verbose', default=False, action='store_true')

parser.add_option('', '--num-subsets', default=utils.DEFAULT_NUM_SUBSETS, type='int')

parser.add_option('', '--prior-min', default=utils.DEFAULT_PRIOR_MIN, type='float')
parser.add_option('', '--prior-max', default=utils.DEFAULT_PRIOR_MAX, type='float')

parser.add_option('', '--hist-bins', default=None, type='int')
parser.add_option('', '--chist-bins', default=None, type='int')
parser.add_option('', '--kde-b', default=utils.DEFAULT_B, type='float')

#parser.add_option('-o', '--output-dir', default='.', type='string')
#parser.add_option('-t', '--tag', default='', type='string')

opts, args = parser.parse_args()
assert args, 'please supply at least 1 input argument\n%s'%__usage__

opts.verbose |= opts.Verbose

#if opts.tag:
#    opts.tag = "_"+opts.tag

logprior = -np.log(opts.prior_max-opts.prior_min)

#-------------------------------------------------

### read in samples
samples = utils.load_hdf5(args, verbose=opts.verbose)['log10NLTides_A0']

if opts.verbose:
    print('partitioning samples into %d subsets'%opts.num_subsets)
subsets = utils.partition(samples, num_subsets=opts.num_subsets)

#-------------------------------------------------

### iterate and compute point estimates for various methods
for foo, b, name in [
        (utils.hist, opts.hist_bins, 'raw histogram'),
        (utils.chist, opts.chist_bins, 'fit cumulative histogram'),
        (utils.kde, opts.kde_b, 'kde with reflecting boundaries'),
    ]:
    print('working on '+name)
    logpost = foo(samples, b=b, prior_min=opts.prior_min, prior_max=opts.prior_max)
    logposts = [foo(subset, b=b, prior_min=opts.prior_min, prior_max=opts.prior_max) for subset in subsets]

    report = '''\
    logpost = %.6f
    logprior = %.6f
    logpost - logpost = %.6f'''%(logpost, logprior, logpost-logprior)
    if opts.Verbose:
        for i, lp in enumerate(logposts):
            report += '''
        subset %02d (%04d samples) logpost - logprior = %.6f'''%(i+1, len(subsets[i]), lp-logprior)
    report += '''
    mean(logpost - logprior) = %.6f
    stdv(logpost - logprior) = %.6f'''%(np.mean(logposts)-logprior, np.std(logposts))
    print(report)

### compute distribution for logpost-logprior
raise NotImplementedError, '''\
compute KDE object and look at distribution of logkde - logprior at prior_min
    find the amount of probability associated with logkde >= logprior at prior_min
'''
obj = utils.FixedBandwidth1DKDE(
        samples, ### FIXME: we really should pass uncorrelated samples here...
        compute=False,
        prior_min=opts.prior_min,
        prior_max=opts.prior_max,
)
obj.optimize()
obj.compute()
